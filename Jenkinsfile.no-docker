/**
 * Jenkins CI/CD Pipeline for Node.js Test Project
 * 
 * –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–ê–Ø –í–ï–†–°–ò–Ø –ë–ï–ó DOCKER
 * –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª, –µ—Å–ª–∏ Docker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ Jenkins
 * 
 * –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
 * - –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω NodeJS Plugin –≤ Jenkins
 * - –ù–∞—Å—Ç—Ä–æ–µ–Ω Node.js –≤ Global Tool Configuration (–∏–º—è: NodeJS-18)
 * 
 * –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–º. –≤ JENKINS_SETUP.md
 */

pipeline {
    // Agent specifies where the pipeline will run
    agent any
    
    // Environment variables for the pipeline
    environment {
        NODE_VERSION = '18'
        PORT = '3000'
    }
    
    // Pipeline stages
    stages {
        /**
         * Stage 1: Checkout
         * Retrieves the source code from the repository
         */
        stage('Checkout') {
            steps {
                echo 'Checking out code from repository...'
                checkout scm
                script {
                    def gitCommit = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    env.GIT_COMMIT_SHORT = gitCommit
                    echo "Git commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }
        
        /**
         * Stage 2: Setup Node.js
         * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Node.js —á–µ—Ä–µ–∑ Jenkins Tool
         * –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ NodeJS Plugin —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Jenkins!
         */
        stage('Setup Node.js') {
            steps {
                echo 'Setting up Node.js...'
                // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–º—è, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —É–∫–∞–∑–∞–ª–∏ –≤ Global Tool Configuration
                // –ó–∞–º–µ–Ω–∏—Ç–µ 'NodeJS-18' –Ω–∞ –≤–∞—à–µ –∏–º—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                script {
                    env.PATH = "${tool name: 'NodeJS-18', type: 'jenkins.plugins.nodejs.tools.NodeJSInstallation'}/bin:${env.PATH}"
                }
                sh 'node --version'
                sh 'npm --version'
                echo 'Node.js setup completed!'
            }
        }
        
        /**
         * Stage 3: Install Dependencies
         * Installs all npm dependencies specified in package.json
         */
        stage('Install Dependencies') {
            steps {
                echo 'Installing dependencies...'
                sh 'npm install'
                echo 'Dependencies installed successfully!'
            }
        }
        
        /**
         * Stage 4: Run Tests
         * Executes the Jest test suite and generates coverage report
         */
        stage('Run Tests') {
            steps {
                echo 'Running tests...'
                sh 'npm test'
                echo 'All tests passed!'
            }
            post {
                always {
                    // Publish test results (if using test reporters)
                    echo 'Test stage completed'
                }
                success {
                    echo 'Tests passed successfully!'
                }
                failure {
                    echo 'Tests failed! Check the logs for details.'
                }
            }
        }
        
        /**
         * Stage 5: Build
         * Validates that the project builds and starts correctly
         */
        stage('Build') {
            steps {
                echo 'Building project...'
                // Verify the project can be built
                sh 'node --version'
                sh 'npm --version'
                
                // Validate main files exist
                sh 'test -f src/index.js || exit 1'
                sh 'test -f src/utils.js || exit 1'
                sh 'test -f package.json || exit 1'
                
                echo 'Build validation successful!'
            }
        }
        
        /**
         * Optional: Deployment Stage
         * This stage can be used to deploy the application
         * Uncomment and modify as needed for your deployment target
         */
        /*
        stage('Deploy') {
            steps {
                echo 'Deploying application...'
                // Add your deployment commands here
                // Examples:
                // - Docker build and push
                // - Deploy to cloud platform
                // - Update server files
            }
        }
        */
    }
    
    // Post-build actions
    post {
        always {
            echo 'Pipeline execution completed'
            // Clean up workspace if needed
            // cleanWs()
        }
        success {
            echo 'Pipeline succeeded! üéâ'
            // You can add notifications here (email, Slack, etc.)
        }
        failure {
            echo 'Pipeline failed! ‚ùå'
            // You can add notifications here for failures
        }
        cleanup {
            echo 'Cleaning up after pipeline execution...'
        }
    }
}

